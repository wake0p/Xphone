# Bug修复验证指南

## 问题描述
在修复之前，当开启自动定时计划并选择某个组作为app分类，且开启强制模式后，直接修改该组的内容（添加或删除app）会导致整个组的app被取消隐藏。

## 修复内容

### 修改的文件
- `PlanReceiver.kt` (第45-60行)

### 核心修改
修改了计算"应该隐藏的包"的逻辑：

**修复前:**
```kotlin
val currentlyShouldBeHidden =
    plans
        .filter { it.isEnabled && it.isActiveNow() }  // 只考虑当前活跃的计划
        .flatMap { it.resolveAllPackages() }
        .toSet()
```

**修复后:**
```kotlin
val currentlyShouldBeHidden =
    plans
        .filter { plan ->
            plan.isEnabled && (plan.isActiveNow() || plan.isForceMode)  // 强制模式一直生效
        }
        .flatMap { it.resolveAllPackages() }
        .toSet()
```

### 修复原理
1. **强制模式的语义**: 强制模式应该意味着app一直被隐藏，不受时间限制
2. **组修改的影响**: 当修改组内容时，会触发 `PlanReceiver` 重新计算隐藏状态
3. **关键逻辑**: 对于强制模式的计划，即使不在活跃时间内，也应该保持app隐藏状态

## 验证步骤

### 场景1: 修改组内容（删除app）
1. 创建一个app组（例如"娱乐组"），包含3个app：抖音、小红书、微博
2. 创建一个定时计划：
   - 选择"娱乐组"
   - 设置时间范围（例如：22:00 - 07:00）
   - **开启强制模式**
   - 启用计划
3. 确认3个app都被隐藏
4. 修改"娱乐组"，删除其中一个app（例如删除"微博"）
5. **验证点**: 
   - ✅ 剩余的2个app（抖音、小红书）应该仍然保持隐藏状态
   - ✅ 被删除的app（微博）应该被恢复显示

### 场景2: 修改组内容（添加app）
1. 使用上述的"娱乐组"和计划设置
2. 向"娱乐组"添加一个新的app（例如"B站"）
3. **验证点**:
   - ✅ 原有的app（抖音、小红书）应该仍然保持隐藏状态
   - ✅ 新添加的app（B站）应该立即被隐藏

### 场景3: 非强制模式下的对比
1. 创建一个新的计划，选择同一个组
2. 设置时间范围（例如：22:00 - 07:00）
3. **不开启强制模式**
4. 启用计划
5. 在非活跃时间（例如白天14:00）修改组内容
6. **验证点**:
   - ✅ 因为不在活跃时间内且非强制模式，app应该保持显示状态
   - ✅ 等到22:00后，所有组内app应该被隐藏

### 场景4: 强制模式下的时间无关性
1. 使用强制模式的计划
2. 在计划的非活跃时间（例如白天14:00）修改组内容
3. **验证点**:
   - ✅ 即使不在活跃时间内，强制模式的app也应该保持隐藏状态
   - ✅ 这证明强制模式不受时间限制

## 日志监控

修复后添加了详细的日志输出，可以通过以下命令查看：

```bash
adb logcat | grep OutPhone
```

关键日志信息：
```
计划[xxx]: 启用=true, 活跃=false, 强制=true, 包数=3
后台同步: 扫描范围 5 (当前 3 + 历史 2), 目标隐藏 3
后台校准: com.example.app -> 禁用
```

## 预期行为

### 强制模式开启
- app **一直**保持隐藏状态
- 修改组内容时，组内的app保持隐藏
- 添加新app到组时，新app立即被隐藏
- 从组中删除app时，该app立即恢复显示

### 强制模式关闭
- app只在计划的活跃时间内隐藏
- 非活跃时间内，app显示正常
- 修改组内容不影响app的显示/隐藏状态（由时间决定）

## 技术细节

### 状态计算流程
1. 获取所有计划和组
2. 解析每个计划的包列表（包括组引用）
3. 计算"应该隐藏"的包集合
   - 启用的计划 && (活跃中 || 强制模式)
4. 对比系统当前状态和目标状态
5. 执行必要的隐藏/恢复操作

### 安全保护
- 核心安全包（app本身和Shizuku管理器）永远不会被隐藏
- 使用状态记忆机制，确保计划删除后能正确恢复app

## 回归测试清单

- [ ] 创建和删除计划功能正常
- [ ] 创建和删除组功能正常
- [ ] 修改组内容后app状态正确
- [ ] 强制模式下app一直隐藏
- [ ] 非强制模式下app按时间隐藏/显示
- [ ] 核心安全包不受影响
- [ ] 计划删除后app能正确恢复
- [ ] 多个计划同时运行时互不干扰
